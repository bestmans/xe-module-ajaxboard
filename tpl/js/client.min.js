/*! Copyright (C) 2014 AJAXBOARD. All rights reserved. */!function(e,t){"use strict";function r(){var r=this,n=e.console,o=["debug","log","info","warn","error"];this.stack=[],t.each(o,function(e,o){r[o]=function(){var e=c.call(arguments);n&&t.isFunction(n[o])?n[o].apply(n,e):this.stack.push([o].concat(e))}})}function n(e){for(var t=14,r={},n=/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,o=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],i=n.exec(e);t--;)i[t]&&(r[o[t]]=i[t]);return delete r.source,r}function o(e){return(e.scheme||"http")+"://"+(e.user||"")+(e.user||e.pass?(e.pass||"")+"@":"")+(e.host||"")+(e.port?":"+e.port:"")+(e.path||"")+(e.query?"?"+e.query:"")+(e.fragment?"#"+e.fragment:"")}function i(e,r,n){function o(e){return e=(e+"").toString(),encodeURIComponent(e).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")}function i(e,r,n){var a=[];return r===!0?r="1":r===!1&&(r="0"),null==r?"":t.isPlainObject(r)?(t.each(r,function(t,r){a.push(i(e+"["+t+"]",r,n))}),a.join(n)):t.isFunction(r)?void 0:o(e)+"="+o(r)}var a=[];return n||(n="&"),t.each(e,function(e,o){r&&t.isNumeric(e)&&(e=String(r)+e);var s=i(e,o,n);""!==s&&a.push(s)}),a.join(n)}function a(e){var r={},n={"null":null,"true":!0,"false":!1};for(e=String(e).trim().replace(/^.*[?]|#.*$/g,"").replace(/\+/g," ").split("&");e.length;){var o=e.shift().split("="),i=decodeURIComponent(o[0]);if(2==o.length){var a=decodeURIComponent(o[1]);a&&!isNaN(a)?a=Number(a):"undefined"===a.toLowerCase()?a=void 0:void 0!==n[a.toLowerCase()]&&(a=n[a.toLowerCase()]),t.isArray(r[i])?r[i].push(a):r[i]=void 0!==r[i]?[r[i],a]:a}else i&&(r[i]=void 0)}return r}function s(){this.connect=!1,this.triggers={},this.triggers.before=[],this.triggers.after=[]}var c=Array.prototype.slice;e.console=new r,s.prototype={insertTrigger:function(e,r,n,o){var i=this.triggers[n];return t.isArray(i)?(i.push({scope:e,name:r,callback:o}),!0):!0},getTriggers:function(e,r){var n=[],o=this.triggers[r];return t.isArray(o)?(o.sort(function(t,r){var n;return n=t.name==r.name?0:r.name==e?1:-1}),t.each(o,function(t,r){var o=!1;return r.name==e?n.push(r):o=!0,!o}),n):n},triggerCall:function(){var e=c.call(arguments),r=e.shift(),n=e.shift(),o=this.getTriggers(r,n),i=!1;return t.each(o,function(r,n){var o=n.scope,a=n.callback;return t.isFunction(a)&&(i=!a.apply(o,e||[])),!i}),!i}};var u=e.ajaxboardStorage=new s;t(function(){function r(e,r,n){this.request_uri=e,this.current_url=r,this.current_mid=n;var o=this,i=["insertTrigger","getTriggers","triggerCall"];t.each(i,function(e,t){o[t]=function(){return u[t].apply(u,c.call(arguments))}})}function s(e){this.oApp=e}r.prototype={ajax:function(r,i,s,c,u){function l(){t(".wfsr").hide().trigger("cancel_confirm")}function g(){t(".wfsr").css("display","none")}u=t.extend(a(i),u||{}),u.module=s||u.module,u.act=c||u.act,e.xeVid&&(u.vid=e.xeVid);var d=function(r){return!!(e.enforce_ssl===!0||r&&e.ssl_actions&&t.isArray(e.ssl_actions)&&t.inArray(r,e.ssl_actions)>-1)}(u.act);i=n(i),delete i.query,delete i.fragment,d&&(i.scheme="https",i.port=e.https_port),i=o(i);var m,f,p;switch(r=r.toLowerCase()){case"xml":var h=[];h.push('<?xml version="1.0" encoding="UTF-8"?>'),h.push("<methodCall>"),h.push("<params>"),t.each(u,function(e,t){h.push("<"+e+"><![CDATA["+t+"]]></"+e+">")}),h.push("</params>"),h.push("</methodCall>"),m=h.join("\n"),f="POST",p="application/xml";break;case"json":case"jsonp":m=t.param(u),f="POST",p="application/json";break;case"html":m=t.param(u),f="GET",p="text/html";break;default:throw new TypeError("Invalid data type")}var v=t(".wfsr");if(v.length&&e.show_waiting_message){var b=v.data("timeout_id");b&&clearTimeout(b),v.css("opacity",0).data("timeout_id",setTimeout(function(){t(".wfsr").css("opacity","")},1e3)).html(e.waiting_message).show()}var _={};_.url=i,_.type=f,_.dataType=r,_.contentType=p,_.data=m,_.success=l,_.error=g,_.timeout=this.timeout,_.global=!1;var C=t.ajax(_);return C.params=u,C},connect:function(r){var a=this;return g.getConfig().done(function(s){delete s.message_type,delete s.message,delete s.error,t.extend(e.xe.lang,s.lang),t.extend(a,s);var c=Number(r||a.type);if(e.io&&t.isFunction(e.io)||(c=2),a.server&&a.server.close(),a.triggerCall("events.connect","before",r))switch(c){case 1:var u,l;(l=n(a.server_host)).host||(l=n(a.request_uri)),l.port=a.server_port,u=o(l);var d={};d.query=i({member_srl:a.member_srl}),d.timeout=a.timeout,d.reconnection=!1;var m=a.server=new e.io(u,d);m.on("connect",function(){m.on("broadcastMessage",function(e){a.triggerCall("events.broadcastMessage","before",e)}),m.on("insertDocument",function(e){a.triggerCall("events.insertDocument","before",e),a.getTriggers("events.insertDocument.detail","before")&&g.getDocument(e.target_srl).done(function(t){a.triggerCall("events.insertDocument.detail","before",e,t)})}),m.on("deleteDocument",function(e){a.triggerCall("events.deleteDocument","before",e)}),m.on("voteDocument",function(e){a.triggerCall("events.voteDocument","before",e)}),m.on("insertComment",function(e){a.triggerCall("events.insertComment","before",e),a.getTriggers("events.insertComment.detail","before")&&g.getComment(e.target_srl).done(function(t){a.triggerCall("events.insertComment.detail","before",e,t)})}),m.on("deleteComment",function(e){a.triggerCall("events.deleteComment","before",e)}),m.on("voteComment",function(e){a.triggerCall("events.voteComment","before",e)}),a.triggerCall("events.connect","after",r)}),m.on("disconnect",function(e){a.triggerCall("events.error","before",e)&&(console.error("socket.io disconnected:",e),a.connect(1))}),m.on("connect_error",function(e){a.triggerCall("events.error","before",e)&&(console.error("socket.io error:",e),a.connect(2))}),m.on("connect_timeout",function(){a.triggerCall("events.timeout","before")&&(console.error("socket.io timeout."),a.connect(1))});break;case 2:default:var f=a.getUid();g.destroyUid(f).done(function(){var e=a.request_uri.setQuery("module","ajaxboard").setQuery("act","getAjaxboardListener").setQuery("uid",f),n=a.server=new EventSource(e);n.addEventListener("broadcastMessage",function(e){var r=t.parseJSON(e.data);a.triggerCall("events.broadcastMessage","before",r)},!1),n.addEventListener("insertDocument",function(e){var r=t.parseJSON(e.data);a.triggerCall("events.insertDocument","before",r),a.getTriggers("events.insertDocument.detail","before")&&g.getDocument(r.target_srl).done(function(e){a.triggerCall("events.insertDocument.detail","before",r,e)})},!1),n.addEventListener("deleteDocument",function(e){var r=t.parseJSON(e.data);a.triggerCall("events.deleteDocument","before",r)},!1),n.addEventListener("voteDocument",function(e){var r=t.parseJSON(e.data);a.triggerCall("events.voteDocument","before",r)},!1),n.addEventListener("insertComment",function(e){var r=t.parseJSON(e.data);a.triggerCall("events.insertComment","before",r),a.getTriggers("events.insertComment.detail","before")&&g.getComment(r.target_srl).done(function(e){a.triggerCall("events.insertComment.detail","before",r,e)})},!1),n.addEventListener("deleteComment",function(e){var r=t.parseJSON(e.data);a.triggerCall("events.deleteComment","before",r)},!1),n.addEventListener("voteComment",function(e){var r=t.parseJSON(e.data);a.triggerCall("events.voteComment","before",r)},!1),t(window).on("beforeunload",function(){g.destroyUid(f)}),a.triggerCall("events.connect","after",r)})}}),this},getUid:function(){return this.uid||this.generateUid()},generateUid:function(){var e=function(e,t){for(var r="0",n=2;t>n;n++)r+="0";return(r+String(e)).slice(-t)},t=new Date,r=[],n=[];return r.push(e(this.member_srl||0,11)),r.push(e(Math.ceil(2147483648*Math.random()),11)),n.push(String(t.getFullYear())),n.push(e(t.getMonth()+1,2)),n.push(e(t.getDate(),2)),n.push(e(t.getHours(),2)),n.push(e(t.getMinutes(),2)),n.push(e(t.getSeconds(),2)),r.push(n.join("")),this.uid=r.join("-")},scrolling:function(e,r,n,o){var i=t(window),a=t(n),s=t(o||"html, body");if(!a.length||!s.length)return this;var c=a.offset().top;switch(c-=s.offset().top,c+=s.scrollTop(),e){case 1:break;case 2:c-=i.height()/2,c+=a.outerHeight(!0)/2;break;case 3:c+=a.outerHeight(!0);break;default:return console.error("Unknown scrolling type"),this}return s.stop().animate({scrollTop:c},r,"easeInOutExpo"),this},clearEditor:function(){if(t("input[name='comment_srl']").val(""),t(".xpress-editor").length){var e=t(".xpress_xeditor_editing_area_container").attr("id").split("-")[3],r=t("#uploaded_file_list_"+e+" option"),n=t("#preview_uploaded_"+e);t("#editor_iframe_"+e).contents().find("body").html(""),r.length&&(uploadedFiles=[],r.remove(),n.empty(),uploaderSettings[e].uploadTargetSrl="")}var o=t(".xeTextEditor");return o.length&&o.find("textarea").val(""),t(".textyleEditor .del").trigger("click"),this.triggerCall("clearEditor","after"),this},deleteDocument:function(e,r,n,o){var i=this;return g.getDocument(e).done(function(a){a.is_granted?confirm(i.lang.msg_ajaxboard_delete_document)&&g.deleteDocument(e).done(function(e,r,o){t.isFunction(n)&&n(e,r,o)}):a.is_exists?confirm(i.lang.msg_ajaxboard_password_required)&&(location.href=r):t.isFunction(o)&&o(e)}),this},deleteComment:function(e,r,n,o){var i=this;return g.getComment(e).done(function(a){a.is_granted?confirm(i.lang.msg_ajaxboard_delete_comment)&&g.deleteComment(e).done(function(e,r,o){t.isFunction(n)&&n(e,r,o)}):a.is_exists?confirm(i.lang.msg_ajaxboard_password_required)&&(location.href=r):t.isFunction(o)&&o(e)}),this}};var l=e.ajaxboard=new r(e.request_uri,e.current_url,e.current_mid);s.prototype={getConfig:function(){return this.oApp.ajax("json",this.oApp.current_url,"ajaxboard","getAjaxboardConfig")},destroyUid:function(e){return this.oApp.ajax("json",this.oApp.current_url,"ajaxboard","procAjaxboardDestroyUid",{uid:e})},getDocument:function(e){return this.oApp.ajax("json",this.oApp.current_url,"ajaxboard","getAjaxboardDocument",{document_srl:e})},deleteDocument:function(e){return this.oApp.ajax("json",this.oApp.request_uri,"board","procBoardDeleteDocument",{document_srl:e})},getComment:function(e){return this.oApp.ajax("json",this.oApp.current_url,"ajaxboard","getAjaxboardComment",{comment_srl:e})},deleteComment:function(e){return this.oApp.ajax("json",this.oApp.request_uri,"board","procBoardDeleteComment",{comment_srl:e})}};var g=new s(l);u.connect===!0&&l.connect()})}(this,jQuery);
