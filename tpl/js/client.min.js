/*! Copyright (C) 2014 AJAXBOARD. All rights reserved. */!function(e,t){"use strict";function r(){var r=this,n=e.console,o=["debug","log","info","warn","error"];this.stack=[],t.each(o,function(e,o){r[o]=function(){var e=c.call(arguments);n&&t.isFunction(n[o])?n[o].apply(n,e):this.stack.push([o].concat(e))}})}function n(e){for(var t=14,r={},n=/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,o=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],a=n.exec(e);t--;)a[t]&&(r[o[t]]=a[t]);return delete r.source,r}function o(e){return(e.scheme||"http")+"://"+(e.user||"")+(e.user||e.pass?(e.pass||"")+"@":"")+(e.host||"")+(e.port?":"+e.port:"")+(e.path||"")+(e.query?"?"+e.query:"")+(e.fragment?"#"+e.fragment:"")}function a(e,r,n){function o(e){return e=(e+"").toString(),encodeURIComponent(e).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")}function a(e,r,n){var i=[];return r===!0?r="1":r===!1&&(r="0"),null==r?"":t.isPlainObject(r)?(t.each(r,function(t,r){i.push(a(e+"["+t+"]",r,n))}),i.join(n)):t.isFunction(r)?void 0:o(e)+"="+o(r)}var i=[];return n||(n="&"),t.each(e,function(e,o){r&&t.isNumeric(e)&&(e=String(r)+e);var s=a(e,o,n);""!==s&&i.push(s)}),i.join(n)}function i(e){var r={},n={"null":null,"true":!0,"false":!1};for(e=String(e).trim().replace(/^.*[?]|#.*$/g,"").replace(/\+/g," ").split("&");e.length;){var o=e.shift().split("="),a=decodeURIComponent(o[0]);if(2==o.length){var i=decodeURIComponent(o[1]);i&&!isNaN(i)?i=Number(i):"undefined"===i.toLowerCase()?i=void 0:void 0!==n[i.toLowerCase()]&&(i=n[i.toLowerCase()]),t.isArray(r[a])?r[a].push(i):r[a]=void 0!==r[a]?[r[a],i]:i}else a&&(r[a]=void 0)}return r}function s(){this.connect=!1,this.triggers={},this.triggers.before=[],this.triggers.after=[]}var c=Array.prototype.slice;e.console=new r,s.prototype={insertTrigger:function(e,r,n,o){var a=this.triggers[n];return t.isArray(a)?(a.push({scope:e,name:r,callback:o}),!0):!0},getTriggers:function(e,r){var n=[],o=this.triggers[r];return t.isArray(o)?(o.sort(function(t,r){var n;return n=t.name==r.name?0:r.name==e?1:-1}),t.each(o,function(t,r){var o=!1;return r.name==e?n.push(r):o=!0,!o}),n):n},triggerCall:function(){var e=c.call(arguments),r=e.shift(),n=e.shift(),o=this.getTriggers(r,n),a=!1;return t.each(o,function(r,n){var o=n.scope,i=n.callback;return t.isFunction(i)&&(a=!i.apply(o,e||[])),!a}),!a}},e.ajaxboardStorage=new s,t(function(){function r(r,n,o){var a=this,i=function(e,r){t.each(r,function(t,r){a[r]=function(){return e[r].apply(e,c.call(arguments))}})};this.request_uri=r,this.current_url=n,this.current_mid=o,i(e.ajaxboardStorage,["insertTrigger","getTriggers","triggerCall"]),e.ajaxboardStorage.connect===!0&&this.connect()}r.prototype={ajax:function(r,a,s,c,u){function l(){t(".wfsr").hide().trigger("cancel_confirm")}function g(){t(".wfsr").css("display","none")}u=t.extend(i(a),u||{}),u.module=s||u.module,u.act=c||u.act,e.xeVid&&(u.vid=e.xeVid);var d=function(r){return!!(e.enforce_ssl===!0||r&&e.ssl_actions&&t.isArray(e.ssl_actions)&&t.inArray(r,e.ssl_actions)>-1)}(u.act);a=n(a),delete a.query,delete a.fragment,d&&(a.scheme="https",a.port=e.https_port),a=o(a);var m,f,p;switch(r=r.toLowerCase()){case"xml":var v=[];v.push('<?xml version="1.0" encoding="UTF-8"?>'),v.push("<methodCall>"),v.push("<params>"),t.each(u,function(e,t){v.push("<"+e+"><![CDATA["+t+"]]></"+e+">")}),v.push("</params>"),v.push("</methodCall>"),m=v.join("\n"),f="POST",p="application/xml";break;case"json":case"jsonp":m=t.param(u),f="POST",p="application/json";break;case"html":m=t.param(u),f="GET",p="text/html";break;default:throw new TypeError("Invalid data type")}var h=t(".wfsr");if(h.length&&e.show_waiting_message){var b=h.data("timeout_id");b&&clearTimeout(b),h.css("opacity",0).data("timeout_id",setTimeout(function(){t(".wfsr").css("opacity","")},1e3)).html(e.waiting_message).show()}var _={};_.url=a,_.type=f,_.dataType=r,_.contentType=p,_.data=m,_.success=l,_.error=g,_.timeout=this.timeout,_.global=!1;var C=t.ajax(_);return C.params=u,C},connect:function(r){var i=this,s=function(){return i.ajax("json",i.current_url,"ajaxboard","getAjaxboardConfig")},c=function(e){return i.ajax("json",i.current_url,"ajaxboard","procAjaxboardDestroyUid",{uid:e})},u=function(e){return i.ajax("json",i.current_url,"ajaxboard","getAjaxboardDocument",{document_srl:e})},l=function(e){return i.ajax("json",i.current_url,"ajaxboard","getAjaxboardComment",{comment_srl:e})};return s().done(function(s){delete s.message_type,delete s.message,delete s.error,t.extend(e.xe.lang,s.lang),t.extend(i,s);var g=Number(r||i.type);if(e.io&&t.isFunction(e.io)||(g=2),i.server&&i.server.close(),i.triggerCall("events.connect","before",r))switch(g){case 1:var d,m;(m=n(i.server_host)).host||(m=n(i.request_uri)),m.port=i.server_port,d=o(m);var f={};f.query=a({member_srl:i.member_srl}),f.timeout=i.timeout,f.reconnection=!1;var p=i.server=new io(d,f);p.on("connect",function(){p.on("broadcastMessage",function(e){i.triggerCall("events.broadcastMessage","before",e)}),p.on("insertDocument",function(e){i.triggerCall("events.insertDocument","before",e),i.getTriggers("events.insertDocument.detail","before")&&u(e.target_srl).done(function(t){i.triggerCall("events.insertDocument.detail","before",e,t)})}),p.on("deleteDocument",function(e){i.triggerCall("events.deleteDocument","before",e)}),p.on("voteDocument",function(e){i.triggerCall("events.voteDocument","before",e)}),p.on("insertComment",function(e){i.triggerCall("events.insertComment","before",e),i.getTriggers("events.insertComment.detail","before")&&l(e.target_srl).done(function(t){i.triggerCall("events.insertComment.detail","before",e,t)})}),p.on("deleteComment",function(e){i.triggerCall("events.deleteComment","before",e)}),p.on("voteComment",function(e){i.triggerCall("events.voteComment","before",e)}),i.triggerCall("events.connect","after",r)}),p.on("disconnect",function(e){i.triggerCall("events.error","before",e)&&(console.error("socket.io disconnected:",e),i.connect(1))}),p.on("connect_error",function(e){i.triggerCall("events.error","before",e)&&(console.error("socket.io error:",e),i.connect(2))}),p.on("connect_timeout",function(){i.triggerCall("events.timeout","before")&&(console.error("socket.io timeout."),i.connect(1))});break;case 2:default:var v=i.getUid();c(v).done(function(){var e=i.request_uri.setQuery("module","ajaxboard").setQuery("act","getAjaxboardListener").setQuery("uid",v),n=i.server=new EventSource(e);n.addEventListener("broadcastMessage",function(e){var r=t.parseJSON(e.data);i.triggerCall("events.broadcastMessage","before",r)},!1),n.addEventListener("insertDocument",function(e){var r=t.parseJSON(e.data);i.triggerCall("events.insertDocument","before",r),i.getTriggers("events.insertDocument.detail","before")&&u(r.target_srl).done(function(e){i.triggerCall("events.insertDocument.detail","before",r,e)})},!1),n.addEventListener("deleteDocument",function(e){var r=t.parseJSON(e.data);i.triggerCall("events.deleteDocument","before",r)},!1),n.addEventListener("voteDocument",function(e){var r=t.parseJSON(e.data);i.triggerCall("events.voteDocument","before",r)},!1),n.addEventListener("insertComment",function(e){var r=t.parseJSON(e.data);i.triggerCall("events.insertComment","before",r),i.getTriggers("events.insertComment.detail","before")&&l(r.target_srl).done(function(e){i.triggerCall("events.insertComment.detail","before",r,e)})},!1),n.addEventListener("deleteComment",function(e){var r=t.parseJSON(e.data);i.triggerCall("events.deleteComment","before",r)},!1),n.addEventListener("voteComment",function(e){var r=t.parseJSON(e.data);i.triggerCall("events.voteComment","before",r)},!1),t(window).on("beforeunload",function(){c(v)}),i.triggerCall("events.connect","after",r)})}}),this},getUid:function(){return this.uid||this.generateUid()},generateUid:function(){function e(e,t){for(var r="0",n=2;t>n;n++)r+="0";return(r+String(e)).slice(-t)}var t=new Date,r=[],n=[];return r.push(e(this.member_srl||0,11)),r.push(e(Math.ceil(2147483648*Math.random()),11)),n.push(String(t.getFullYear())),n.push(e(t.getMonth()+1,2)),n.push(e(t.getDate(),2)),n.push(e(t.getHours(),2)),n.push(e(t.getMinutes(),2)),n.push(e(t.getSeconds(),2)),r.push(n.join("")),this.uid=r.join("-")},scrolling:function(e,r,n,o){var a=t(window),i=t(n),s=t(o||"html, body");if(!i.length||!s.length)return this;var c=i.offset().top;switch(c-=s.offset().top,c+=s.scrollTop(),e){case 1:break;case 2:c-=a.height()/2,c+=i.outerHeight(!0)/2;break;case 3:c+=i.outerHeight(!0);break;default:return console.error("Unknown scrolling type"),this}return s.stop().animate({scrollTop:c},r,"easeInOutExpo"),this},clearEditor:function(){if(t("input[name='comment_srl']").val(""),t(".xpress-editor").length){var e=t(".xpress_xeditor_editing_area_container").attr("id").split("-")[3],r=t("#uploaded_file_list_"+e+" option"),n=t("#preview_uploaded_"+e);t("#editor_iframe_"+e).contents().find("body").html(""),r.length&&(uploadedFiles=[],r.remove(),n.empty(),uploaderSettings[e].uploadTargetSrl="")}var o=t(".xeTextEditor");return o.length&&o.find("textarea").val(""),t(".textyleEditor .del").trigger("click"),this.triggerCall("clearEditor","after"),this},deleteDocument:function(e,r,n,o){var a=this,i=function(e){return a.ajax("json",a.request_uri,"ajaxboard","getAjaxboardDocument",{document_srl:e})},s=function(e){return a.ajax("json",a.request_uri,"board","procBoardDeleteDocument",{document_srl:e})};return i(e).done(function(i){i.is_granted?confirm(a.lang.msg_ajaxboard_delete_document)&&s(e).done(function(e,r,o){t.isFunction(n)&&n(e,r,o)}):i.is_exists?confirm(a.lang.msg_ajaxboard_password_required)&&(location.href=r):t.isFunction(o)&&o(e)}),this},deleteComment:function(e,r,n,o){var a=this,i=function(e){return a.ajax("json",a.request_uri,"ajaxboard","getAjaxboardComment",{comment_srl:e})},s=function(e){return a.ajax("json",a.request_uri,"board","procBoardDeleteComment",{comment_srl:e})};return i(e).done(function(i){i.is_granted?confirm(a.lang.msg_ajaxboard_delete_comment)&&s(e).done(function(e,r,o){t.isFunction(n)&&n(e,r,o)}):i.is_exists?confirm(a.lang.msg_ajaxboard_password_required)&&(location.href=r):t.isFunction(o)&&o(e)}),this}},e.ajaxboard=new r(e.request_uri,e.current_url,e.current_mid)})}(this,jQuery);
