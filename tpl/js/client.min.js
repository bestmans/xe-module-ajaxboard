/*! Copyright (C) 2014 AJAXBOARD. All rights reserved. */var ajaxboard=function(e,t){"use strict";function r(){var r=this,n=e.console,o=["debug","log","info","warn","error"];this.stack=[],t.each(o,function(e,o){r[o]=function(){var e=s.call(arguments);n&&t.isFunction(n[o])?n[o].apply(n,e):this.stack.push([o].concat(e))}})}function n(e){for(var t=14,r={},n=/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*):?([^:@]*))?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,o=["source","scheme","authority","userInfo","user","pass","host","port","relative","path","directory","file","query","fragment"],a=n.exec(e);t--;)a[t]&&(r[o[t]]=a[t]);return delete r.source,r}function o(e){return(e.scheme||"http")+"://"+(e.user||"")+(e.user||e.pass?(e.pass||"")+"@":"")+(e.host||"")+(e.port?":"+e.port:"")+(e.path||"")+(e.query?"?"+e.query:"")+(e.fragment?"#"+e.fragment:"")}function a(e,r,n){function o(e){return e=(e+"").toString(),encodeURIComponent(e).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")}function a(e,r,n){var i=[];return r===!0?r="1":r===!1&&(r="0"),null==r?"":t.isPlainObject(r)?(t.each(r,function(t,r){i.push(a(e+"["+t+"]",r,n))}),i.join(n)):t.isFunction(r)?void 0:o(e)+"="+o(r)}var i=[];return n||(n="&"),t.each(e,function(e,o){r&&t.isNumeric(e)&&(e=String(r)+e);var s=a(e,o,n);""!==s&&i.push(s)}),i.join(n)}function i(e){var r={},n={"null":null,"true":!0,"false":!1};for(e=String(e).trim().replace(/^.*[?]|#.*$/g,"").replace(/\+/g," ").split("&");e.length;){var o=e.shift().split("="),a=decodeURIComponent(o[0]);if(2==o.length){var i=decodeURIComponent(o[1]);i&&!isNaN(i)?i=Number(i):"undefined"===i.toLowerCase()?i=void 0:void 0!==n[i.toLowerCase()]&&(i=n[i.toLowerCase()]),t.isArray(r[a])?r[a].push(i):r[a]=void 0!==r[a]?[r[a],i]:i}else a&&(r[a]=void 0)}return r}var s=Array.prototype.slice;e.console=new r;var c,l,u=!1,d={before:[],after:[]};return l={lang:{},insertTrigger:function(e,r,n){var o=d[r];return t.isArray(o)?(o.push({name:e,callback:n}),!0):!1},getTriggers:function(e,r){var n=[],o=d[r];return t.isArray(o)?(o.sort(function(t,r){var n;return n=t.name==r.name?0:r.name==e?1:-1}),t.each(o,function(t,r){var o=!1;return r.name==e?n.push(r):o=!0,!o}),n):n},triggerCall:function(){var e=s.call(arguments),r=e.shift(),n=e.shift(),o=this.getTriggers(r,n),a=!1;return t.each(o,function(r,n){var o=n.callback;return t.isFunction(o)&&(a=!o.apply(o,e||[])),!a}),!a},ajax:function(r,a,s,c,l){function u(){t(".wfsr").hide().trigger("cancel_confirm")}function d(){t(".wfsr").css("display","none")}l=t.extend(i(a),l||{}),l.module=s||l.module,l.act=c||l.act,e.xeVid&&(l.vid=e.xeVid);var g=function(r){return!!(e.enforce_ssl===!0||r&&e.ssl_actions&&t.isArray(e.ssl_actions)&&t.inArray(r,e.ssl_actions)>-1)}(l.act);a=n(a||location.href),delete a.query,delete a.fragment,g&&(a.scheme="https",a.port=e.https_port),a=o(a);var m,f,v;switch(r=r.toLowerCase()){case"xml":var h=[];h.push('<?xml version="1.0" encoding="UTF-8"?>'),h.push("<methodCall>"),h.push("<params>"),t.each(l,function(e,t){h.push("<"+e+"><![CDATA["+t+"]]></"+e+">")}),h.push("</params>"),h.push("</methodCall>"),m=h.join("\n"),f="POST",v="application/xml";break;case"json":case"jsonp":m=t.param(l),f="POST",v="application/json";break;case"html":m=t.param(l),f="GET",v="text/html";break;default:throw new TypeError("Invalid data type")}var p=t(".wfsr");if(p.length&&e.show_waiting_message){var b=p.data("timeout_id");b&&clearTimeout(b),p.css("opacity",0).data("timeout_id",setTimeout(function(){t(".wfsr").css("opacity","")},1e3)).html(e.waiting_message).show()}var C={};C.url=a,C.type=f,C.dataType=r,C.contentType=v,C.data=m,C.success=u,C.error=d,C.timeout=this.timeout,C.global=!1;var _=t.ajax(C);return _.params=l,_},connect:function(r,i){if(u&&!i)return this;var s=this,l=Number(r||this.type);if(e.io&&t.isFunction(e.io)||(l=2),2===l&&!e.EventSource)return this;if(!this.triggerCall("events.connect","before",r))return this;switch(this.server&&this.server.close(),l){case 1:var d,g,m,f={};(d=n(this.server_host)).host||(d=n(this.request_uri)).host||(d=n(location.href)),d.port=this.server_port,g=o(d),f.query=a({member_srl:this.member_srl}),f.timeout=this.timeout,f.reconnection=!1,m=this.server=new e.io(g,f),m.on("connect",function(){m.on("sendMessage",function(e){s.triggerCall("events.sendMessage","before",e)}),m.on("broadcastMessage",function(e){s.triggerCall("events.broadcastMessage","before",e)}),m.on("insertDocument",function(e){s.triggerCall("events.insertDocument","before",e),s.getTriggers("events.insertDocument.detail","before")&&c.getDocument(e.target_srl).done(function(t){s.triggerCall("events.insertDocument.detail","before",e,t)})}),m.on("deleteDocument",function(e){s.triggerCall("events.deleteDocument","before",e)}),m.on("voteDocument",function(e){s.triggerCall("events.voteDocument","before",e)}),m.on("insertComment",function(e){s.triggerCall("events.insertComment","before",e),s.getTriggers("events.insertComment.detail","before")&&c.getComment(e.target_srl).done(function(t){s.triggerCall("events.insertComment.detail","before",e,t)})}),m.on("deleteComment",function(e){s.triggerCall("events.deleteComment","before",e)}),m.on("voteComment",function(e){s.triggerCall("events.voteComment","before",e)}),s.triggerCall("events.connect","after",r)}),m.on("disconnect",function(e){s.triggerCall("events.error","before",e)&&(console.error("socket.io disconnected:",e),s.connect(1,!0))}),m.on("connect_error",function(e){s.triggerCall("events.error","before",e)&&(console.error("socket.io error:",e),s.connect(2,!0))}),m.on("connect_timeout",function(){s.triggerCall("events.timeout","before")&&(console.error("socket.io timeout."),s.connect(1,!0))});break;case 2:default:var g=(this.request_uri||location.href).setQuery("module","ajaxboard").setQuery("act","getAjaxboardListener"),m=this.server=new EventSource(g);m.addEventListener("message",function(e){"connect"===e.data&&(m.addEventListener("sendMessage",function(e){var r=t.parseJSON(e.data);s.triggerCall("events.sendMessage","before",r)}),m.addEventListener("broadcastMessage",function(e){var r=t.parseJSON(e.data);s.triggerCall("events.broadcastMessage","before",r)},!1),m.addEventListener("insertDocument",function(e){var r=t.parseJSON(e.data);s.triggerCall("events.insertDocument","before",r),s.getTriggers("events.insertDocument.detail","before")&&c.getDocument(r.target_srl).done(function(e){s.triggerCall("events.insertDocument.detail","before",r,e)})},!1),m.addEventListener("deleteDocument",function(e){var r=t.parseJSON(e.data);s.triggerCall("events.deleteDocument","before",r)},!1),m.addEventListener("voteDocument",function(e){var r=t.parseJSON(e.data);s.triggerCall("events.voteDocument","before",r)},!1),m.addEventListener("insertComment",function(e){var r=t.parseJSON(e.data);s.triggerCall("events.insertComment","before",r),s.getTriggers("events.insertComment.detail","before")&&c.getComment(r.target_srl).done(function(e){s.triggerCall("events.insertComment.detail","before",r,e)})},!1),m.addEventListener("deleteComment",function(e){var r=t.parseJSON(e.data);s.triggerCall("events.deleteComment","before",r)},!1),m.addEventListener("voteComment",function(e){var r=t.parseJSON(e.data);s.triggerCall("events.voteComment","before",r)},!1),s.triggerCall("events.connect","after",r))})}return u||t(window).on("beforeunload",function(){s.server&&s.server.close()}),u=!0,this},deleteDocument:function(e,r,n,o){var a=this;return c.getDocument(e).done(function(i){i.is_granted?confirm(a.lang.msg_ajaxboard_delete_document)&&c.deleteDocument(e).done(function(e,r,o){t.isFunction(n)&&n(e,r,o)}):i.is_exists?confirm(a.lang.msg_ajaxboard_password_required)&&(location.href=r):t.isFunction(o)&&o(e)}),this},deleteComment:function(e,r,n,o){var a=this;return c.getComment(e).done(function(i){i.is_granted?confirm(a.lang.msg_ajaxboard_delete_comment)&&c.deleteComment(e).done(function(e,r,o){t.isFunction(n)&&n(e,r,o)}):i.is_exists?confirm(a.lang.msg_ajaxboard_password_required)&&(location.href=r):t.isFunction(o)&&o(e)}),this},scrolling:function(e,r,n,o){var a=t(window),i=t(n),s=t(o||"html, body");if(!i.length||!s.length)return this;var c=i.offset().top;switch(c-=s.offset().top,c+=s.scrollTop(),e){case 1:break;case 2:c-=a.height()/2,c+=i.outerHeight(!0)/2;break;case 3:c+=i.outerHeight(!0);break;default:return console.error("Unknown scrolling type"),this}return s.stop().animate({scrollTop:c},r,"easeInOutExpo"),this},clearEditor:function(){if(t("input[name='comment_srl']").val(""),t(".xpress-editor").length){var e=t(".xpress_xeditor_editing_area_container").attr("id").split("-")[3],r=t("#uploaded_file_list_"+e+" option"),n=t("#preview_uploaded_"+e);t("#editor_iframe_"+e).contents().find("body").html(""),r.length&&(uploadedFiles=[],r.remove(),n.empty(),uploaderSettings[e].uploadTargetSrl="")}var o=t(".xeTextEditor");return o.length&&o.find("textarea").val(""),t(".textyleEditor .del").trigger("click"),this.triggerCall("clearEditor","after"),this}},c={getDocument:function(e){return l.ajax("json",l.current_url,"ajaxboard","getAjaxboardDocument",{document_srl:e})},deleteDocument:function(e){return l.ajax("json",l.request_uri,"board","procBoardDeleteDocument",{document_srl:e})},getComment:function(e){return l.ajax("json",l.current_url,"ajaxboard","getAjaxboardComment",{comment_srl:e})},deleteComment:function(e){return l.ajax("json",l.request_uri,"board","procBoardDeleteComment",{comment_srl:e})}},t(function(){t.extend(l,e.ajaxboardConfig),l.connect()}),l}(this,jQuery);
